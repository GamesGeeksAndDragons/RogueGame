using System;
using Assets.Characters;
using Assets.Deeds;
using Assets.Level;
using Assets.Mazes;
using Assets.Messaging;
using Assets.Resources;
using Assets.Tiles;
using AssetsTests.Fakes;
using AssetsTests.Helpers;
using AssetsTests.RoomTests;
using Utils;
using Utils.Dispatching;
using Utils.Display;
using Utils.Random;
using Xunit;
using Xunit.Abstractions;

namespace AssetsTests.DispatcherTests
{
    public class LevelBuilderTests
    {
        private readonly ITestOutputHelper _output;

        public LevelBuilderTests(ITestOutputHelper output)
        {
            _output = output;
        }

        static class LevelExpectedResults
        {
            public const string Level1 = @"
  |012345678901234567890123456789|  
------------------------------------
0 |██████████████████████████████|0 
1 |██████████████████████████████|1 
2 |██████████████████████████████|2 
3 |██████████████████████████████|3 
4 |██████████████████████████████|4 
5 |██████████████████████████████|5 
6 |██████████████████████████████|6 
7 |██████████████████████████████|7 
8 |██████████████████████████████|8 
9 |██████████████████████████████|9 
10|██████████████████████████████|10
11|██████████████████████████████|11
12|██████████████████████████████|12
13|██████████████████████████████|13
14|██████████████████████████████|14
15|██████████████████████████████|15
16|███████╔════════╗█████████████|16
17|███████║¹¹¹¹¹¹¹¹║█████████████|17
18|███████║¹¹¹¹¹¹¹¹║█████████████|18
19|███████║¹¹¹¹¹¹¹¹║█████████████|19
20|███████║¹¹¹¹¹¹¹¹║█████████████|20
21|███████║¹¹¹¹¹¹¹¹║█████████████|21
22|███████║¹¹¹¹¹¹¹¹║█████████████|22
23|███████║¹¹¹¹¹¹@¹║█████████████|23
24|███████║M¹¹¹¹¹¹¹║█████████████|24
25|███████╚════════╝█████████████|25
26|██████████████████████████████|26
27|██████████████████████████████|27
28|██████████████████████████████|28
29|██████████████████████████████|29
------------------------------------
  |012345678901234567890123456789|  
";

            public const string Level2 = @"
  |012345678901234567890123456789012345|  
------------------------------------------
0 |████████████████████████████████████|0 
1 |████████████                        |1 
2 |████████████ ██████████████████████ |2 
3 |████████████ ██████████████████████ |3 
4 |████████████ ██████████████████████ |4 
5 |████████████ ██████████████████████ |5 
6 |████████████ ██████████████████████ |6 
7 |██████                        █████ |7 
8 |██████ █████ ████████████████ █████ |8 
9 |██████ █████ ███████████╔════1═══╗█ |9 
10|██████ █████ ███████████║¹¹¹M¹¹¹¹║█ |10
11|██████ █████ ███████████║¹¹¹¹¹¹¹¹║█ |11
12|██████ █████ ███████████║¹¹¹¹¹¹¹¹║█ |12
13|██████ ╔════2═══╗███████║¹¹¹M¹¹¹¹║█ |13
14|██████ ║²²²²²²²²║███████║¹@¹¹¹¹¹¹║█ |14
15|██████ 1²²²²²²²²║███████║¹¹¹¹¹¹¹¹║█ |15
16|███████║²²²²²²²²║███████║¹M¹¹¹¹¹¹║█ |16
17|███████║²²²²²²²²║███████║¹¹¹¹¹¹¹¹2  |17
18|███████║²²²²²²²²║███████╚════════╝██|18
19|███████║²²²²²²²²║███████████████████|19
20|███████║²²²²²²²²║███████████████████|20
21|███████║²²²²²²²²║███████████████████|21
22|███████╚════════╝███████████████████|22
23|████████████████████████████████████|23
24|████████████████████████████████████|24
25|████████████████████████████████████|25
26|████████████████████████████████████|26
27|████████████████████████████████████|27
28|████████████████████████████████████|28
29|████████████████████████████████████|29
30|████████████████████████████████████|30
31|████████████████████████████████████|31
32|████████████████████████████████████|32
33|████████████████████████████████████|33
34|████████████████████████████████████|34
35|████████████████████████████████████|35
------------------------------------------
  |012345678901234567890123456789012345|  
";

            public const string Level3 = @"
  |012345678901234567890123456789012345678901234567890123456789012345678901234567890123|  
------------------------------------------------------------------------------------------
0 |████████████████████████████████████████████████████████████████████████████████████|0 
1 |██████████                                                                      ████|1 
2 |██████████ ██ █████████████████████████████████████████████████████████████ ███ ████|2 
3 |█████╔════1══3╗████████████████████████████████████████████████████████████ ███ ████|3 
4 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|4 
5 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|5 
6 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|6 
7 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|7 
8 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|8 
9 |█████║¹¹¹¹¹¹¹¹║████████████████████████████████████████████████████████████ ███ ████|9 
10|█████║¹¹¹M¹¹¹¹║██           ███████████████████████████████████████████████ ███ ████|10
11|█████║¹¹¹¹¹¹¹¹║██ █████████ ███████████████████████████████████████████████ ███ ████|11
12|█████╚════════╝██ █████████ ███████████████████████████████████████████████ ███ ████|12
13|█████████████████ ██╔══════2══╗████████████████████████████████████████████ ███ ████|13
14|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ███ ████|14
15|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ███ ████|15
16|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ███ ████|16
17|█████████████████ ██║³³╔═³═╗³³║████████████████████████████████████████████ ███ ████|17
18|█████████████████ ██║³³║³³³║³³1                                                 ████|18
19|█████████████████ ██║³³║³³³║³³║████████████████████████████████████████████ ████████|19
20|█████████████████ ██║³³╚═══╝³@║████████████████████████████████████████████ ████████|20
21|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ████████|21
22|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ████████|22
23|█████████████████ ██║³³³³³³³³³║████████████████████████████████████████████ ████████|23
24|█████████████████ ██╚════════3╝████████████████████████████████████████████ ████████|24
25|█████████████████ ███████████ █████████████████████████████████████████████ ████████|25
26|█████████████████ ███████████ █████████████████████████████████████████████ ████████|26
27|█████████████████ ███████████ █████████████████████████████████████████████ ████████|27
28|█████████████████ ███████████ █████████████████████████████████████████████ ████████|28
29|█████████████████ ███████████ █████████████████████████████████████████████ ████████|29
30|█████████████████ ███████████ █████████████████████████████████████████████ ████████|30
31|█████████████████ ███████████ █████████████████████████████████████████████ ████████|31
32|█████████████████ ███████████ █████████████████████████████████████████████ ████████|32
33|█████████████████ ███████████ █████████████████████████████████████████████ ████████|33
34|█████████████████ ███████████ █████████████████████████████████████████████ ████████|34
35|█████████████████ ███████████ █████████████████████████████████████████████ ████████|35
36|█████████████████ ███████████ █████████████████████████████████████████████ ████████|36
37|█████████████████ ███████████ █████████████████████████████████████████████ ████████|37
38|█████████████████ ███████████                                               ████████|38
39|█████████████████ ██████████████████████████████████████████████████████████████████|39
40|█████████████████ ██████████████████████████████████████████████████████████████████|40
41|█████████████████ ██████████████████████████████████████████████████████████████████|41
42|█████████████████ ██████████████████████████████████████████████████████████████████|42
43|█████████████████ ██████████████████████████████████████████████████████████████████|43
44|█████████████████ ██████████████████████████████████████████████████████████████████|44
45|█████████████████ ██████████████████████████████████████████████████████████████████|45
46|█████████████████ ██████████████████████████████████████████████████████████████████|46
47|█████████████████ ██████████████████████████████████████████████████████████████████|47
48|█████████████████ ██████████████████████████████████████████████████████████████████|48
49|█████████████████ ██████████████████████████████████████████████████████████████████|49
50|█████████████████ ██████████████████████████████████████████████████████████████████|50
51|█████████████████ ██████████████████████████████████████████████████████████████████|51
52|█████████████████ ██████████████████████████████████████████████████████████████████|52
53|█████████████████ ██████████████████████████████████████████████████████████████████|53
54|█████████████████ ██████████████████████████████████████████████████████████████████|54
55|█████████████████ ██████████████████████████████████████████████████████████████████|55
56|█████████████████ ██████████████████████████████████████████████████████████████████|56
57|█████████████████ ██████████████████████████████████████████████████████████████████|57
58|█████████████████ ██████████████████████████████████████████████████████████████████|58
59|█████████████████ ██████████████████████████████████████████████████████████████████|59
60|█████████████████ ██████████████████████████████████████████████████████████████████|60
61|█████████████████ ██████████████████████████████████████████████████████████████████|61
62|█████████████████ ██████████████████████████████████████████████████████████████████|62
63|█████████████████ ██████████████████████████████████████████████████████████████████|63
64|█████████████████ ██████████████████╔════════╗██████████████████████████████████████|64
65|█████████████████ ██████████████████║²²²²²²²²║██████████████████████████████████████|65
66|█████████████████                   2²²²²²²²²║██████████████████████████████████████|66
67|████████████████████████████████████║²²²²²²²²║██████████████████████████████████████|67
68|████████████████████████████████████║²²M²²²²²║██████████████████████████████████████|68
69|████████████████████████████████████║²²²²²²²²║██████████████████████████████████████|69
70|████████████████████████████████████║²²²²²²²²║██████████████████████████████████████|70
71|████████████████████████████████████║²²²²²²²M║██████████████████████████████████████|71
72|████████████████████████████████████║²²²²²²²²║██████████████████████████████████████|72
73|████████████████████████████████████╚════════╝██████████████████████████████████████|73
74|████████████████████████████████████████████████████████████████████████████████████|74
75|████████████████████████████████████████████████████████████████████████████████████|75
76|████████████████████████████████████████████████████████████████████████████████████|76
77|████████████████████████████████████████████████████████████████████████████████████|77
78|████████████████████████████████████████████████████████████████████████████████████|78
79|████████████████████████████████████████████████████████████████████████████████████|79
80|████████████████████████████████████████████████████████████████████████████████████|80
81|████████████████████████████████████████████████████████████████████████████████████|81
82|████████████████████████████████████████████████████████████████████████████████████|82
83|████████████████████████████████████████████████████████████████████████████████████|83
84|████████████████████████████████████████████████████████████████████████████████████|84
85|████████████████████████████████████████████████████████████████████████████████████|85
86|████████████████████████████████████████████████████████████████████████████████████|86
------------------------------------------------------------------------------------------
  |012345678901234567890123456789012345678901234567890123456789012345678901234567890123|  
";

            public static string GetExpectation(int level)
            {
                return level switch
                {
                    1 => Level1,
                    2 => Level2,
                    3 => Level3,
                    _ => throw new ArgumentException($"Error getting expectation for unknown level [{level}]")
                };
            }
        }

        internal void AssertTest(IMaze maze, int level, IDispatchRegistry dispatchRegistry)
        {
            var actual = maze.Print(dispatchRegistry);
            var expected = LevelExpectedResults.GetExpectation(level).Trim(CharHelpers.EndOfLine);

            _output.WriteLine(BuilderTestHelpers.Divider + " expected " + BuilderTestHelpers.Divider);
            _output.WriteLine(expected);
            _output.WriteLine(BuilderTestHelpers.Divider + " expected " + BuilderTestHelpers.Divider);
            _output.WriteLine(BuilderTestHelpers.Divider + " actual " + BuilderTestHelpers.Divider);
            _output.WriteLine(actual);
            _output.WriteLine(BuilderTestHelpers.Divider + " actual " + BuilderTestHelpers.Divider);

            Assert.Equal(expected, actual);
        }


        [Theory]
        [InlineData(1)]
        [InlineData(2)]
        [InlineData(3)]
        public void WhenBuiltDispatcher_ShouldHaveLevelCharacters(int level)
        {
            var dispatchRegistry = new DispatchRegistry();
            var actionRegistry = new ActionRegistry();
            var dispatcher = new Dispatcher(dispatchRegistry, actionRegistry);
            var dieBuilder = new DieBuilder();
            var fakeLogger = new FakeLogger(_output);
            var resourceBuilder = new ResourceBuilder(dispatchRegistry, actionRegistry);

            var builder = new LevelBuilder(dieBuilder, fakeLogger, dispatcher, dispatchRegistry, actionRegistry, resourceBuilder);
            var (maze, _) = builder.Build(level);

            var before = maze.Print(dispatchRegistry);
            _output.WriteLine(BuilderTestHelpers.Divider + " before " + BuilderTestHelpers.Divider);
            _output.WriteLine(before);

            dispatcher.Dispatch();

            AssertTest(maze, level, dispatchRegistry);
        }
    }
}