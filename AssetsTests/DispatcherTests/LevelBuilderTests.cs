using System;
using Assets.Characters;
using Assets.Deeds;
using Assets.Level;
using Assets.Mazes;
using Assets.Messaging;
using Assets.Resources;
using Assets.Tiles;
using AssetsTests.Fakes;
using AssetsTests.Helpers;
using AssetsTests.RoomTests;
using Utils;
using Utils.Dispatching;
using Utils.Display;
using Utils.Random;
using Xunit;
using Xunit.Abstractions;

namespace AssetsTests.DispatcherTests
{
    public class LevelBuilderTests
    {
        private readonly ITestOutputHelper _output;

        public LevelBuilderTests(ITestOutputHelper output)
        {
            _output = output;
        }

        static class LevelExpectedResults
        {
            public const string Level1 = @"
  |012345678901234567890123456789|  
------------------------------------
0 |██████████████████████████████|0 
1 |██████████████████████████████|1 
2 |██████████████████████████████|2 
3 |██████████████████████████████|3 
4 |██████████████████████████████|4 
5 |██████████████████████████████|5 
6 |██████████████████████████████|6 
7 |██████████████████████████████|7 
8 |██████████████████████████████|8 
9 |██████████████████████████████|9 
10|██████████████████████████████|10
11|██████████████████████████████|11
12|██████████████████████████████|12
13|██████████████████████████████|13
14|██████████████████████████████|14
15|██████████████████████████████|15
16|███████╔════════╗█████████████|16
17|███████║¹¹¹¹¹¹¹¹║█████████████|17
18|███████║¹¹¹¹¹¹¹¹║█████████████|18
19|███████║¹¹¹¹¹¹¹¹║█████████████|19
20|███████║¹¹¹¹¹¹¹¹║█████████████|20
21|███████║¹¹¹¹¹¹¹¹║█████████████|21
22|███████║¹¹¹¹¹¹¹¹║█████████████|22
23|███████║¹¹¹¹¹¹@¹║█████████████|23
24|███████║M¹¹¹¹¹¹¹║█████████████|24
25|███████╚════════╝█████████████|25
26|██████████████████████████████|26
27|██████████████████████████████|27
28|██████████████████████████████|28
29|██████████████████████████████|29
------------------------------------
  |012345678901234567890123456789|  
";

            public const string Level2 = @"
  |012345678901234567890123456789012345|  
------------------------------------------
0 |████████████████████████████████████|0 
1 |████████████████████████████████████|1 
2 |████████████████████████████████████|2 
3 |████████████████████████████████████|3 
4 |████████████████████████████████████|4 
5 |████████████████████████████████████|5 
6 |████████████████████████████████████|6 
7 |█████████████             ██████████|7 
8 |█████████████ ███████████ ██████████|8 
9 |█████████████ ██████████╔1═══════╗██|9 
10|█████████████ ██████████║¹¹¹@¹¹¹¹║██|10
11|█████████████ ██████████║¹¹¹¹¹¹¹¹║██|11
12|█████████████ ██████████║¹¹¹¹¹¹¹¹║██|12
13|███████╔═════1══╗███████║¹¹¹M¹¹¹¹║██|13
14|███████║²²²²²²²²║███████║¹¹¹¹¹¹¹¹║██|14
15|███████║²²²²²²²²║███████║¹¹¹¹¹¹¹¹║██|15
16|███████║²²²²²²²²║███████║¹M¹¹¹¹¹¹║██|16
17|███████║²²²²²²²²║██████ 2¹¹¹¹¹¹¹¹║██|17
18|███████║²²²²²²²²║██████ ╚════════╝██|18
19|███████║²²²²²²²²║██████ ████████████|19
20|███████║²²²²²²²²║██████ ████████████|20
21|███████║²²²²²²²²║██████ ████████████|21
22|███████╚═══════2╝██████ ████████████|22
23|███████████████ ███████ ████████████|23
24|███████████████ ███████ ████████████|24
25|███████████████         ████████████|25
26|████████████████████████████████████|26
27|████████████████████████████████████|27
28|████████████████████████████████████|28
29|████████████████████████████████████|29
30|████████████████████████████████████|30
31|████████████████████████████████████|31
32|████████████████████████████████████|32
33|████████████████████████████████████|33
34|████████████████████████████████████|34
35|████████████████████████████████████|35
------------------------------------------
  |012345678901234567890123456789012345|  
";

            public const string Level3 = @"
  |012345678901234567890123456789012345678901234567890123456789012345678901234567890|  
---------------------------------------------------------------------------------------
0 |█████████████████████████████████████████████████████████████████████████████████|0 
1 |█████████████████████████████████████████████████████████████████████████████████|1 
2 |█████████████████████████████████████████████████████████████████████████████████|2 
3 |█████████████████████████████████████████████████████████████████████████████████|3 
4 |█████████████████████████████████████████████████████████                 ███████|4 
5 |█████████████████████████████████████████████████████████ ██████████╔════2═══╗███|5 
6 |█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|6 
7 |█████████████████████████████████████████████████████████ ██████████║@²²²²²²²║███|7 
8 |█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|8 
9 |█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|9 
10|█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|10
11|█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|11
12|█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|12
13|█████████████████████████████████████████████████████████ ██████████║²²²²²²²²║███|13
14|█████████████████████████████████████████████████████████ ██████████╚════════╝███|14
15|█████████████████████████████████████████████████████████ ███████████████████████|15
16|█████████████████████████████████████████████████████████ ███████████████████████|16
17|█████████████████████████████████████████████████████████ ███████████████████████|17
18|█████████████████████████████████████████████████████████ ███████████████████████|18
19|█████████████████████████████████████████████████████████ ███████████████████████|19
20|█████████████████████████████████████████████████████████ ███████████████████████|20
21|█████████████████████████████████████████████████████████ ███████████████████████|21
22|█████████████████████████████████████████████████████████ ███████████████████████|22
23|█████████████████████████████████████████████████████████ ███████████████████████|23
24|█████████████████████████████████████████████████████████ ███████████████████████|24
25|█████████████████████████████████████████████████████████ ███████████████████████|25
26|█████████████████████████████████████████████████████████ ███████████████████████|26
27|█████████████████████████████████████████████████████████ ███████████████████████|27
28|█████████████████████████████████████████████████████████ ███████████████████████|28
29|█████████████████████████████████████████████████████████ ███████████████████████|29
30|█████████████████████████████████████████████████████████ ███████████████████████|30
31|█████████████████████████████████████████████████████████ ███████████████████████|31
32|█████████████████████████████████████████████████████████ ███████████████████████|32
33|█████████████████████████████████████████████████████████ ███████████████████████|33
34|█████████████████████████████████████████████████████████ ███████████████████████|34
35|█████████████████████████████████████████████████████████ ███████████████████████|35
36|█████████████████████████████████████████████████████████ ███████████████████████|36
37|█████████████████████████████████████████████████████████ ███████████████████████|37
38|█████████████████████████████████████████████████████████ ███████████████████████|38
39|█████████████████████████████████████████████████████████ ███████████████████████|39
40|█████████                     ███████████████████████████ ███████████████████████|40
41|███╔═════1══╗████████████████ ███████████████████████████ ███████████████████████|41
42|███║³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|42
43|███║³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|43
44|███║M³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|44
45|███║³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|45
46|███║³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|46
47|███║³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|47
48|███║³³³³³³M³║████████████████ ███████████████████████████ ███████████████████████|48
49|█  3³³³³³³³³║████████████████ ███████████████████████████ ███████████████████████|49
50|█ █╚═══════2╝████████████████ ███████████████████████████ ███████████████████████|50
51|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|51
52|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|52
53|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|53
54|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|54
55|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|55
56|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|56
57|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|57
58|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|58
59|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|59
60|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|60
61|█ █████████ █████████████████ ███████████████████████████ ███████████████████████|61
62|█ █████████ ████████████████╔1═══════╗███████████████████ ███████████████████████|62
63|█ █████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|63
64|█ █████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|64
65|█                           3¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|65
66|███████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|66
67|███████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|67
68|███████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|68
69|███████████ ████████████████║¹¹¹¹¹¹¹¹║███████████████████ ███████████████████████|69
70|███████████ ████████████████║¹M¹¹¹¹¹¹║███████████████████ ███████████████████████|70
71|███████████ ████████████████╚════════╝███████████████████ ███████████████████████|71
72|███████████ █████████████████████████████████████████████ ███████████████████████|72
73|███████████ █████████████████████████████████████████████ ███████████████████████|73
74|███████████ █████████████████████████████████████████████ ███████████████████████|74
75|███████████ █████████████████████████████████████████████ ███████████████████████|75
76|███████████                                               ███████████████████████|76
77|█████████████████████████████████████████████████████████████████████████████████|77
78|█████████████████████████████████████████████████████████████████████████████████|78
79|█████████████████████████████████████████████████████████████████████████████████|79
80|█████████████████████████████████████████████████████████████████████████████████|80
---------------------------------------------------------------------------------------
  |012345678901234567890123456789012345678901234567890123456789012345678901234567890|  
";

            public static string GetExpectation(int level)
            {
                switch (level)
                {
                    case 1: return Level1;
                    case 2: return Level2;
                    case 3: return Level3;
                }

                throw new ArgumentException($"Error getting expectation for unknown level [{level}]");
            }
        }

        internal void AssertTest(IMaze maze, int level, IDispatchRegistry dispatchRegistry)
        {
            var actual = maze.Print(dispatchRegistry);
            var expected = LevelExpectedResults.GetExpectation(level).Trim(CharHelpers.EndOfLine);

            _output.WriteLine(RoomTestHelpers.Divider + " expected " + RoomTestHelpers.Divider);
            _output.WriteLine(expected);
            _output.WriteLine(RoomTestHelpers.Divider + " expected " + RoomTestHelpers.Divider);
            _output.WriteLine(RoomTestHelpers.Divider + " actual " + RoomTestHelpers.Divider);
            _output.WriteLine(actual);
            _output.WriteLine(RoomTestHelpers.Divider + " actual " + RoomTestHelpers.Divider);

            Assert.Equal(expected, actual);
        }


        [Theory]
        [InlineData(1)]
        [InlineData(2)]
        [InlineData(3)]
        public void WhenBuiltDispatcher_ShouldHaveLevelCharacters(int level)
        {
            var dispatchRegistry = new DispatchRegistry();
            var actionRegistry = new ActionRegistry();
            var dispatcher = new Dispatcher(dispatchRegistry, actionRegistry);
            var fakeRandomNumbers = new DieBuilder();
            var fakeLogger = new FakeLogger(_output);
            var resourceBuilder = new ResourceBuilder(dispatchRegistry, actionRegistry);

            var builder = new LevelBuilder(fakeRandomNumbers, fakeLogger, dispatcher, dispatchRegistry, actionRegistry, resourceBuilder);
            var (maze, _) = builder.Build(level);

            var before = maze.Print(dispatchRegistry);
            _output.WriteLine(RoomTestHelpers.Divider + " before " + RoomTestHelpers.Divider);
            _output.WriteLine(before);

            dispatcher.Dispatch();

            AssertTest(maze, level, dispatchRegistry);
        }
    }
}